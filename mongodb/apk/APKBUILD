# Maintainer: Dima Pulkinen <dima@itsemast.com>
pkgname=mongodb
pkgver=6.2.0
pkgrel=0
pkgdesc="A high-performance, open source, schema-free document-oriented database"
url="http://www.mongodb.org"
arch="x86_64"
options="!check"
license='SSPL-1.0'
makedepends="boost-dev curl-dev cyrus-sasl-dev fmt-dev libpcap-dev libstemmer-dev libunwind-dev
	mongo-c-driver-dev openssl-dev pcre2-dev py3-cheetah py3-distro py3-gitpython py3-mongo py3-psutil
	py3-pydantic py3-setuptools py3-yaml scons snappy-dev tcmalloc valgrind-dev yaml-cpp-dev zlib-dev"
source="http://downloads.mongodb.org/src/mongodb-src-r$pkgver.tar.gz
	fix-backtrace.patch
	fix-default-stacksize.patch
	fix-elf-native-class.patch
	fix-gperftools.patch
	fix-kms_request.patch
	fix-mozjs.patch
	fix-processinfo_linux.patch
	fix-resolv.patch
	fix-s2-with-boost.patch
	fix-wiredtiger.patch
"

builddir="$srcdir"/$pkgname-src-r$pkgver

build() {
	export SCONSFLAGS="$MAKEFLAGS"
	scons \
		--allocator=system \
		--disable-warnings-as-errors \
		--ssl \
		--use-sasl-client \
		--use-system-boost \
		--use-system-fmt \
		--use-system-pcre2 \
		--use-system-snappy \
		--use-system-stemmer \
		--use-system-tcmalloc \
		--use-system-libunwind \
		--use-system-valgrind \
		--use-system-yaml \
		--use-system-zlib \
		--use-system-zstd \
		--use-system-mongo-c=on \
		CXXFLAGS="$CXXFLAGS -Wno-interference-size -DBOOST_LOG_DYN_LINK -DFMT_HEADER_ONLY" \
		CCFLAGS="$CCFLAGS $(pkg-config --cflags libmongoc-1.0)" \
		PREFIX="/usr" \
		install-core
}

package() {
	install -Dm755 build/install/usr/bin/mongod "$pkgdir/usr/bin/mongod"
	install -Dm755 build/install/usr/bin/mongos "$pkgdir/usr/bin/mongos"
}

sha512sums="ee6e2c66da6291073cc64f3031eb34697029da09a71fa0b47282fd8f8a1a7b185834b9b46300ffa31f64aac92a2e094269c6f386a4f344a40c847f58e213988e  mongodb-src-r6.2.0.tar.gz
7f87dfce0c0a8c28d699998b081a85e84ab745d1529777487b891ba3f6e8de911006a8a67c489c38d568a69b0f7fa1615064e1d44b7571ed7592726b46a98727  fix-backtrace.patch
23f5b74715f41ff0998f07ad207e773b6fb06e375fe558fb812bc009e01367fbfd8a91391e2d1749d3bd4b9dc430ad3cdcd47163aadb6eb100869d3c9ef4a029  fix-default-stacksize.patch
bb314e320825bc70a77db5a9ae07848fd1cec46edb41e8d94ce1effb0e5e0115636755a484924356c15d60f0e623c4b34197ef759accf9d156bcd2d11dbf5d61  fix-elf-native-class.patch
fe63189e3abf2324c3e5fdb4ac1077e2a179855651b7847d9aae9917c49f0d75762d07ecaf4a5bf357d7192a3a4301a76cf0c4727a2e910a990f0eece7bc2807  fix-gperftools.patch
320228ea50f1652c89c015f2e82a63b0e2ce7e6efa169a6e719190c26c024e95a8606c6b2db94435b1316d98945f28d909a6ffa88e3e3f949bd75ef85c935de9  fix-kms_request.patch
8689b0d6c5e596d6c3b159dddaeaae314cae8859b87d0a130c669df74b1331bf1d58d005d37a2514f217da9204c94c6348f6e877d3ee7a0cdf18068acfaaec6e  fix-mozjs.patch
cd14aed29606ed09e8d8b1b98b4e9e264dcb8191eb99376cefa6dda64b58ca3cfab1f2f60b119cb2f4c6a844901d59832bd6ae31de32aae2888b48854732ef2d  fix-processinfo_linux.patch
ecee715dc51c485081fd216e1bb8f54d2632519b352781ca5f0a1d715864733fecf17da6603cccf01c3cabbce135051e7931116fc418d5a315dc8f592a31350c  fix-resolv.patch
62f4802a26398ffb17ac289d9e9de4044b753ece694785d3462f406391abdcfd16ff281959b4e4fb6751cc9247da7a4c55e8fa48eb90fd681eed724fedcb03e9  fix-s2-with-boost.patch
ecbe6cb579b33dd4888096712f150772db06fd38219ca2a7679b1dc1ee73b0c3f5ee498af12ecd0265b5231a9fe6b7c12b2c1d606ed04caa6aa00c3ad3fe925a  fix-wiredtiger.patch"
